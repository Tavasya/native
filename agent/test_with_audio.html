<!DOCTYPE html>
<html>
<head>
    <title>Push-to-Talk with Audio Publishing</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; }
        .recording { background-color: #ff4444; color: white; }
        .idle { background-color: #44ff44; color: black; }
        #status { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Push-to-Talk Test with Audio</h1>
    
    <div id="status">Status: Loading...</div>
    
    <button id="connectBtn">Connect to Room</button>
    <button id="publishBtn" disabled>Publish Audio</button>
    <button id="startBtn" disabled>Start Talking</button>
    <button id="endBtn" disabled>End Turn</button>
    
    <div id="messages"></div>

    <script type="module">
        import { Room, RoomEvent, RemoteAudioTrack, LocalAudioTrack } from 'https://unpkg.com/livekit-client@1.15.13/dist/livekit-client.esm.mjs';
        
        let room;
        let audioTrack;
        let isRecording = false;
        
        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const publishBtn = document.getElementById('publishBtn');
        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const messages = document.getElementById('messages');
        
        function updateStatus(msg) {
            status.textContent = 'Status: ' + msg;
            console.log(msg);
        }
        
        function addMessage(msg) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        updateStatus('Ready');
        
        connectBtn.addEventListener('click', async () => {
            try {
                room = new Room();
                
                room.on(RoomEvent.Connected, () => {
                    updateStatus('Connected');
                    connectBtn.disabled = true;
                    publishBtn.disabled = false;
                    addMessage('Connected to room');
                });
                
                room.on(RoomEvent.Disconnected, () => {
                    updateStatus('Disconnected');
                    connectBtn.disabled = false;
                    publishBtn.disabled = true;
                    startBtn.disabled = true;
                    endBtn.disabled = true;
                    addMessage('Disconnected from room');
                });
                
                room.on(RoomEvent.ParticipantConnected, (participant) => {
                    addMessage(`Participant joined: ${participant.identity}`);
                    if (participant.identity === 'ptt-agent') {
                        startBtn.disabled = false;
                        addMessage('Agent is ready for push-to-talk!');
                    }
                });
                
                room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track instanceof RemoteAudioTrack) {
                        const audioElement = track.attach();
                        document.body.appendChild(audioElement);
                        addMessage('Audio track received from ' + participant.identity);
                    }
                });
                
                // Connect to room
                const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiVGVzdCBVc2VyIiwidmlkZW8iOnsicm9vbUpvaW4iOnRydWUsInJvb20iOiJ0ZXN0LXJvb20iLCJjYW5QdWJsaXNoIjp0cnVlLCJjYW5TdWJzY3JpYmUiOnRydWUsImNhblB1Ymxpc2hEYXRhIjp0cnVlfSwic3ViIjoidGVzdC11c2VyIiwiaXNzIjoiQVBJWjhjTVRLVFZuNUM3IiwibmJmIjoxNzUxNjc2NDI1LCJleHAiOjE3NTE2OTgwMjV9.nRLZQk3gzxcQ1xMWAcjCI14uL--5Tx_tz5EINMrcLL4';
                await room.connect('wss://native-gnrz1nth.livekit.cloud', token);
                
            } catch (error) {
                updateStatus('Connection failed: ' + error.message);
                addMessage('Connection failed: ' + error.message);
            }
        });
        
        publishBtn.addEventListener('click', async () => {
            try {
                // Get microphone stream
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioTrack = stream.getAudioTracks()[0];
                
                // Create LocalAudioTrack from MediaStreamTrack
                const localAudioTrack = new LocalAudioTrack(audioTrack);
                await room.localParticipant.publishTrack(localAudioTrack);
                
                publishBtn.disabled = true;
                addMessage('Audio track published - this should trigger the agent');
                
                // Wait for agent to join
                setTimeout(() => {
                    const agentParticipant = Array.from(room.participants.values())
                        .find(p => p.identity === 'ptt-agent');
                    
                    if (agentParticipant) {
                        startBtn.disabled = false;
                        addMessage('Agent found! Ready for push-to-talk');
                    } else {
                        addMessage('Agent not found yet, waiting...');
                    }
                }, 3000);
                
            } catch (error) {
                addMessage('Failed to publish audio: ' + error.message);
            }
        });
        
        startBtn.addEventListener('click', async () => {
            try {
                const agentParticipant = Array.from(room.participants.values())
                    .find(p => p.identity === 'ptt-agent');
                
                if (!agentParticipant) {
                    addMessage('Agent not found in room');
                    return;
                }
                
                // Send data message instead of RPC
                const encoder = new TextEncoder();
                const data = encoder.encode('start_turn');
                
                await room.localParticipant.publishData(data);
                
                isRecording = true;
                startBtn.disabled = true;
                endBtn.disabled = false;
                startBtn.className = 'recording';
                updateStatus('Recording...');
                addMessage('Started recording');
                
            } catch (error) {
                addMessage('Failed to start turn: ' + error.message);
            }
        });
        
        endBtn.addEventListener('click', async () => {
            try {
                const agentParticipant = Array.from(room.participants.values())
                    .find(p => p.identity === 'ptt-agent');
                
                if (!agentParticipant) {
                    addMessage('Agent not found in room');
                    return;
                }
                
                // Send data message instead of RPC
                const encoder = new TextEncoder();
                const data = encoder.encode('end_turn');
                
                await room.localParticipant.publishData(data);
                
                isRecording = false;
                startBtn.disabled = false;
                endBtn.disabled = true;
                startBtn.className = 'idle';
                updateStatus('Processing...');
                addMessage('Ended recording, processing...');
                
            } catch (error) {
                addMessage('Failed to end turn: ' + error.message);
            }
        });
        
        // Enable microphone access
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                addMessage('Microphone access granted');
            })
            .catch(error => {
                addMessage('Microphone access denied: ' + error.message);
            });
    </script>
</body>
</html>